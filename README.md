# Causal Inference Pipeline

This project contains a pipeline script for causal inference of multivariate time series. The user can configure data sources, preprocessing options and the causal methods used for causal analysis.
Options also include analysis of spatially resolved data (in .npy format), and causal stationarity (a sliding time window approach). Results are visualized in different types of plots, including graphs and maps.

I developed this pipeline in the context of my master's thesis at TU Berlin and the Potsdam Institute for Climate Impact Research. 

# Setup

It's recommended to start by installing GNU Octave, which is used to run the GCSS algorithm, and adding it to the PATH (see https://pypi.org/project/oct2py/).

After that, install the requirements.txt (recommended into a virtual environment), and install the tigramite package manually, following https://github.com/jakobrunge/tigramite/.

Should the LFS file for spatially resolved sea ice not be downloadable due to Github's limitations, refer to https://drive.google.com/file/d/1GYc6_fQL6Xr080TPPgz65-85_O83wWLm/view?usp=sharing for download.

# Usage

The Pipeline.py file contains the main pipeline, which can be run from the command line with several arguments, run Pipeline.py -h for a list and description of arguments. Test files in CSV and NPY format are included.

The following command runs causal analysis on three time series from the testSheet.csv file with masking (arbitrarily chosen), and a causal stationarity analysis afterwards:
```
py Pipeline.py -filename_in "./testSheet.csv" -dirname_out "testResults" -vars "SeaIce" "AMOC" "GrIS" -mask "mask_pcmci" "mask_lkif" "mask_pcmci" -mask_lkif "mask_lkif" -maskType "x" -detrend True True True -deseason True True True -diff True True True -tauMax 10 -alpha 0.1 -forbiddenLinks [0,2] -causalStationarity True -stationarityWindow 3 -stationarityShift 12 -stationarityVars 0 2
```
Spatial analysis requires an npy array with dimensions x,y,time. Further, latitude and longitude needs to be provided to plot the output correctly, in two separate npy files, each with dimensions x,y (for some projections, this might have to be generated by the user first, for some it is provided in common .nc files).

The following command runs a spatial analysis on the provided spatially resolved sea ice data, which has also been detrended and deseasonalised already. Note that preprocessing is only available for time series from CSV files.
```
py Pipeline.py -filename_in "./testSheet.csv" -dirname_out "testResults" -vars "SeaIce" "AMOC" "GrIS" -mask "mask_pcmci" "mask_lkif" "mask_pcmci" -mask_lkif "mask_lkif" -maskType "x" -detrend True True True -deseason True True True -spatialAnalysis True -spatialFile testSeaIceAlbedo_Detrended.npy -spatialLon polarLongitudeAggregated.npy -spatialLat polarLatitudeAggregated.npy -spatialOtherVar 0
```

The scripts Evaluation.py and GridEvaluation.py correspond to two sets of experiments I conducted for my master's thesis on synthetic data (generated from DataGenerator.py), one can entirely reproduce the corresponding results from these scripts.

The applied experiments of my thesis can be reproduced with the pipeline script, the data sources and the preprocessing steps as listed in my thesis.

# References
The GCSS algorithm and its implementation are by Barnett & Seth: https://github.com/lcbarnett/ssgc/tree/master

L. Barnett and A. K. Seth, “Granger causality for state-space models,” Physical Review E, vol. 91, no. 4, p. 040 101, Apr. 23, 2015.

The package used for LKIF was developed by Rong based on work by Liang: https://github.com/YinengRong/LKIF/tree/main

X. S. Liang, “Normalized Multivariate Time Series Causality Analysis and Causal Graph Reconstruction,” Entropy, vol. 23, no. 6, p. 679, Jun. 2021.

The PCMCI algorithm and the tigramite package are by Runge: https://github.com/jakobrunge/tigramite/

J. Runge, P. Nowack, M. Kretschmer, S. Flaxman, and D. Sejdinovic, “Detecting and quantifying causal associations in large nonlinear time series datasets,” Science Advances, vol. 5, no. 11, eaau4996, Nov. 2019.

Test data on arctic sea ice albedo was processed from a sea ice reanalysis product generated by neXtSIM taken from the Copernicus Marine Data Store, available at: https://data.marine.copernicus.eu/product/ARCTIC_MULTIYEAR_PHY_ICE_002_016/description
